<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda de Eventos</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #0f0f15; color: white; padding: 20px; }
    .agenda-titulo { font-size: 1.4em; margin-bottom: 15px; }
    .fila { display: flex; align-items: center; gap: 10px; }
    .hora-ovalo {
      background: #1e3a8a; color: white; padding: 4px 10px;
      border-radius: 12px; font-weight: bold; font-size: 0.9em;
    }
    .nombre-evento { flex: 1; font-size: 0.95em; }
    .nombre-servidor {
      display: block; color: #4ade80; margin-top: 4px;
      text-decoration: none; font-size: 0.9em;
    }
    .nombre-servidor:hover { text-decoration: underline; }
    .servidores { display: none; padding-left: 32px; }
    .servidores.activo { display: block; }
    .evento { border-bottom: 1px solid #222; padding: 12px 0; }
  </style>
</head>
<body>
  <h2 class="agenda-titulo">Cargando agenda...</h2>
  <ul id="eventos"></ul>

  <script>
    const AGENDA_URLS = [
      "https://ftvhd.com/diaries.json"
      // "https://golazoplay.com/agenda.json"
    ];

    document.addEventListener("DOMContentLoaded", function () {
      obtenerAgenda();
      setInterval(refrescarAgenda, 60000);
    });

    document.addEventListener("click", function (e) {
      const evento = e.target.closest(".evento");
      if (!evento) return;
      const servidores = evento.querySelector(".servidores");
      if (!servidores) return;

      const estaActivo = servidores.classList.contains("activo");
      document.querySelectorAll(".servidores").forEach(s => s.classList.remove("activo"));

      if (!estaActivo) {
        servidores.classList.add("activo");
      }
    });

    function convertToUserTimeZone(limaHour) {
      const DateTime = luxon.DateTime;
      const dt = DateTime.fromFormat(limaHour, "HH:mm", { zone: "America/Lima" });
      return dt.toLocal().toFormat("HH:mm");
    }

    function formatDate(dateString) {
      const options = { year: "numeric", month: "long", day: "numeric" };
      return new Date(dateString).toLocaleDateString("es-ES", options);
    }

    async function refrescarAgenda() {
      await obtenerAgenda();
      console.log("Agenda actualizada");
    }

    async function obtenerAgenda() {
      const menuElement = document.getElementById("eventos");
      const titleAgendaElement = document.querySelector(".agenda-titulo");

      try {
        let misCanales = [];

        // Cargar canales propios
        try {
          const res = await fetch('canales_con_logo.json');
          if (res.ok) {
            misCanales = await res.json();
          } else {
            console.warn("No se encontró 'canales_con_logo.json'");
          }
        } catch (err) {
          console.warn("Error al cargar canales propios:", err);
        }

        // Cargar agenda externa
        let data = [];
        for (const url of AGENDA_URLS) {
          try {
            const res = await fetch(url);
            const json = await res.json();
            if (Array.isArray(json.data)) {
              data = data.concat(json.data);
            }
          } catch (err) {
            console.error("Error en fuente:", url, err);
          }
        }

        // Generar JSON-LD para SEO
        const sportsEvents = data.map(ev => {
          const attr = ev.attributes;
          const dateTime = `${attr.date_diary}T${attr.diary_hour}-05:00`;
          const competencia = attr.country?.data?.attributes?.name || "Evento en vivo";
          const description = attr.diary_description.trim().replace(/\s+/g, ' ');
          const embedUrl = (attr.embeds?.data[0]?.attributes?.embed_iframe) 
            ? `https://ftvhd.com${attr.embeds.data[0].attributes.embed_iframe}` 
            : "https://ftvhd.com";

          return {
            "@type": "SportsEvent",
            "name": description,
            "startDate": dateTime,
            "eventStatus": "https://schema.org/EventScheduled",
            "eventAttendanceMode": "https://schema.org/OnlineEventAttendanceMode",
            "location": { "@type": "Place", "name": competencia },
            "url": embedUrl,
            "organizer": {
              "@type": "Organization",
              "name": "Eventos Eta Silk",
              "url": "https://eventos-eta-silk.com/"
            },
            "description": `Transmisión en vivo de ${competencia}`
          };
        });

        // Inyectar JSON-LD
        let ldScript = document.createElement('script');
        ldScript.type = 'application/ld+json';
        ldScript.text = JSON.stringify({ "@context": "https://schema.org", "@graph": sportsEvents }, null, 2);
        const oldScript = document.querySelector('script[type="application/ld+json"]');
        if (oldScript) oldScript.remove();
        document.head.appendChild(ldScript);

        // Renderizar interfaz
        menuElement.innerHTML = "";
        const dateCompleted = formatDate(new Date().toISOString());
        titleAgendaElement.textContent = "Agenda - " + dateCompleted;

        data.sort((a, b) => a.attributes.diary_hour.localeCompare(b.attributes.diary_hour));

        data.forEach((value) => {
          let imageUrl = "https://panel.futbollibretvs.pe/uploads/sin_imagen_d36205f0e8.png";
          const imgPath = value.attributes.country?.data?.attributes?.image?.data?.attributes?.url;
          if (imgPath) {
            imageUrl = "https://panel.futbollibretvs.pe" + imgPath;
          }

          const hora = convertToUserTimeZone(value.attributes.diary_hour);
          const nombre = value.attributes.diary_description;

          let html = `
            <li class="evento" style="list-style: none;">
              <div class="fila">
                <span class="hora-ovalo">${hora}</span>
                <img src="${imageUrl}" alt="bandera" style="width: 18px; height: 18px; border-radius: 50%;">
                <span class="nombre-evento">${nombre}</span>
              </div>
              <div class="servidores" style="margin-top: 8px;">`;

          if (value.attributes.embeds?.data?.length > 0) {
            value.attributes.embeds.data.forEach((embed) => {
              const nombreServidor = embed.attributes.embed_name || "Servidor";
              const miCanal = misCanales.find(c =>
                nombreServidor.toLowerCase().includes(c.nombre?.toLowerCase())
              );

              if (miCanal && miCanal.m3u8) {
                const urlCodificada = btoa(miCanal.m3u8);
                html += `<a href="/embed/reproductor_m3u8.html?src=${urlCodificada}" target="_blank" class="nombre-servidor">➤ ${nombreServidor} (Calidad HD)</a>`;
              } else {
                const urlDirecto = embed.attributes.embed_iframe || "#";
                const urlCodificada = btoa(urlDirecto);
                html += `<a href="/embed/reproductor.html?r=${urlCodificada}" target="_blank" class="nombre-servidor">➤ ${nombreServidor}</a>`;
              }
            });
          } else {
            html += `<span class="nombre-servidor" style="color: #888;">Próximamente...</span>`;
          }

          html += `</div></li>`;
          menuElement.innerHTML += html;
        });

      } catch (err) {
        console.error("Error general:", err);
        menuElement.innerHTML = `<li style="color: red; padding: 20px;">Error al cargar la agenda.</li>`;
      }
    }
  </script>
</body>
</html>

